#!/sbin/openrc-run

name="shhoook"
description="shhoook - impressed with the server (HTTP -> shell hooks)"
command="/usr/local/bin/shhoook"
command_background="yes"
pidfile="/run/${RC_SVCNAME}.pid"

# Settings
CONFIG_DIR="${CONFIG_DIR:-/etc/shhoook/conf}"

WAIT_IFACE="${WAIT_IFACE:-tun0}"     # tailscale0 / wg0 / tun0
PORT="${PORT:-8080}"                 # â† port
WAIT_IP="${WAIT_IP:-}"               # if you want to wait for a specific IP, otherwise it's empty.
WAIT_V4_PREFIX="${WAIT_V4_PREFIX:-}" # optional: 10.8. or 100.64. to select the desired address

depend() {
  need net
  after firewall
}

start_pre() {
  export CONFIG_DIR

  i=0
  while [ $i -lt 60 ]; do
    if ip link show dev "$WAIT_IFACE" >/dev/null 2>&1; then

      # We take IPv4 from the interface (the first one), or by prefix
      ip4="$(ip -4 -o addr show dev "$WAIT_IFACE" | awk '{print $4}' | cut -d/ -f1)"

      if [ -n "$WAIT_V4_PREFIX" ]; then
        ip4="$(echo "$ip4" | tr ' ' '\n' | grep -m1 "^${WAIT_V4_PREFIX}" || true)"
      else
        ip4="$(echo "$ip4" | awk 'NR==1{print $1}')"
      fi

      # If WAIT_IP is set, we are waiting for it.
      if [ -n "$WAIT_IP" ]; then
        if ip -4 addr show dev "$WAIT_IFACE" | grep -q " ${WAIT_IP}/"; then
          ip4="$WAIT_IP"
        else
          ip4=""
        fi
      fi

      if [ -n "$ip4" ]; then
        LISTEN_ADDR="${ip4}:${PORT}"
        export LISTEN_ADDR
        einfo "Using LISTEN_ADDR=${LISTEN_ADDR} (from ${WAIT_IFACE})"
        return 0
      fi
    fi

    i=$((i+1))
    sleep 1
  done

  eerror "No IPv4 on ${WAIT_IFACE} (wanted: ${WAIT_IP:-any}), not starting."
  return 1
}